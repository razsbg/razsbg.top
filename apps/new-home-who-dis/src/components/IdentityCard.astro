---
// @ts-nocheck
import { db } from "../db/index.js"
import { users } from "../db/schema.js"
import { sql } from "drizzle-orm"
import { getSessionIdFromCookie } from "../lib/session.js"

// Fetch user from session cookie (server-side)
const sessionId = getSessionIdFromCookie(Astro.request)
let user = null

if (sessionId) {
  // @ts-ignore - Drizzle type mismatch between query builder and sql template
  const foundUsers = await db
    .select()
    .from(users)
    .where(sql`${users.sessionId} = ${sessionId}`)
    .limit(1)
  
  const foundUser = foundUsers[0]
  if (foundUser) {
    user = {
      id: foundUser.id,
      pseudonym: foundUser.pseudonym,
      sessionId: foundUser.sessionId,
      createdAt: foundUser.createdAt,
    }
    
    // Update last active (fire and forget, don't block rendering)
    // @ts-ignore - Drizzle type mismatch
    db.update(users)
      .set({ lastActive: new Date() })
      .where(sql`${users.id} = ${foundUser.id}`)
      .then(() => {})
      .catch((err) => console.error('Failed to update last_active:', err))
  }
}
---

<div class="identity-card" id="identity-card" data-user={user ? JSON.stringify(user) : ''}>
  {!user ? (
    <div class="loading-state">
      <span class="spinner">‚è≥</span>
      <span>Creating your identity...</span>
    </div>
  ) : (
    <>
      <div class="identity-content">
        <div class="pseudonym-display">
          <span class="label">You are:</span>
          <span class="pseudonym" id="pseudonym-text">{user.pseudonym}</span>
        </div>
        
        <button
          class="regenerate-btn"
          id="regenerate-btn"
          type="button"
        >
          üîÑ Change Identity
        </button>
      </div>
      
      <div class="error-message" id="error-message" style="display: none;">
        <span id="error-text"></span>
      </div>
    </>
  )}
</div>

<style>
  .identity-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    padding: 1.5rem;
    color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .error-message {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 0.5rem;
    padding: 1rem;
    color: #fecaca;
    margin-top: 1rem;
  }

  .loading-state {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    justify-content: center;
    padding: 1rem;
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .identity-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .pseudonym-display {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    text-align: center;
  }

  .label {
    font-size: 0.875rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .pseudonym {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.025em;
  }

  .regenerate-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .regenerate-btn:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
  }

  .regenerate-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (min-width: 640px) {
    .pseudonym {
      font-size: 2rem;
    }
  }
</style>

<script>
  // Client-side interactivity
  const initializeIdentity = async () => {
    const card = document.getElementById('identity-card')
    const userData = card?.dataset.user
    
    // If no user data, create a new session
    if (!userData) {
      try {
        const response = await fetch('/api/users/session', {
          method: 'POST',
        })
        const data = await response.json()
        
        if (data.success && data.user) {
          // Reload page to show the new user
          window.location.reload()
        }
      } catch (error) {
        console.error('Error creating session:', error)
      }
    }
    
    // Handle regenerate button
    const regenerateBtn = document.getElementById('regenerate-btn') as HTMLButtonElement | null
    if (regenerateBtn) {
      regenerateBtn.addEventListener('click', async () => {
        if (!confirm('Generate a new pseudonym? Your current one will be lost.')) {
          return
        }
        
        regenerateBtn.disabled = true
        regenerateBtn.textContent = '‚è≥ Changing...'
        
        try {
          const response = await fetch('/api/users/session', {
            method: 'PUT',
          })
          const data = await response.json()
          
          if (data.success && data.user) {
            // Update pseudonym in DOM
            const pseudonymText = document.getElementById('pseudonym-text')
            if (pseudonymText) {
              pseudonymText.textContent = data.user.pseudonym
            }
            regenerateBtn.textContent = 'üîÑ Change Identity'
            regenerateBtn.disabled = false
          } else {
            throw new Error(data.error || 'Failed to regenerate')
          }
        } catch (error) {
          console.error('Error regenerating:', error)
          const errorMsg = document.getElementById('error-message')
          const errorText = document.getElementById('error-text')
          if (errorMsg && errorText) {
            let message = error instanceof Error ? error.message : 'Unknown error'
            // Check if it's the commitment error
            if (message.includes('after committing to gifts')) {
              message = 'üîí You cannot change your identity after committing to gifts. Your pseudonym is now permanent!'
            }
            errorText.textContent = `‚ö†Ô∏è ${message}`
            errorMsg.style.display = 'block'
          }
          regenerateBtn.textContent = 'üîÑ Change Identity'
          regenerateBtn.disabled = false
        }
      })
    }
  }
  
  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeIdentity)
  } else {
    initializeIdentity()
  }
</script>
