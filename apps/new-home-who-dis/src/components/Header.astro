---
// @ts-nocheck
import Logo from "./Logo.astro"
import { getSessionIdFromCookie } from "../lib/session.js"
import { db } from "../db/index.js"
import { users } from "../db/schema.js"
import { sql } from "drizzle-orm"

// Check if user has a pseudonym
let hasPseudonym = false
try {
  const sessionId = getSessionIdFromCookie(Astro.request)

  if (sessionId) {
    const userResult = await db
      .select()
      .from(users)
      .where(sql`${users.sessionId} = ${sessionId}`)
      .limit(1)

    if (userResult.length > 0 && userResult[0]) {
      hasPseudonym = true
    }
  }
} catch (error) {
  console.error("Error checking user session:", error)
}

// Get current path for active link styling
const currentPath = Astro.url.pathname
---

<header class="px-8 bg-fuchsia-900 text-white shadow-lg sticky top-0 z-50">
  <div class="container-custom">
    <div class="flex items-center justify-between py-4">
      <!-- Logo -->
      <a
        href="/"
        class="flex items-center gap-3 hover:opacity-80 transition-opacity"
      >
        <Logo size="sm" />
      </a>

      <!-- Burger Menu Button (Mobile) -->
      <button 
        id="burger-menu-btn"
        class="md:hidden flex flex-col gap-1.5 w-8 h-8 items-center justify-center"
        aria-label="Toggle menu"
      >
        <span class="burger-line"></span>
        <span class="burger-line"></span>
        <span class="burger-line"></span>
      </button>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-2 md:gap-4">
        <a
          href="/"
          class={`nav-link ${currentPath === "/" ? "active" : ""}`}
          aria-current={currentPath === "/" ? "page" : undefined}
        >
          Home
        </a>

        <a
          href="/identity"
          class={`nav-link ${currentPath === "/identity" ? "active" : ""}`}
          aria-current={currentPath === "/identity" ? "page" : undefined}
        >
          Identity
        </a>

        {
          hasPseudonym && (
            <>
              <a
                href="/gifts"
                class={`nav-link ${currentPath === "/gifts" ? "active" : ""}`}
                aria-current={currentPath === "/gifts" ? "page" : undefined}
              >
                Gifts
              </a>
              
              <a
                href="/commitments"
                class={`nav-link ${currentPath === "/commitments" ? "active" : ""}`}
                aria-current={currentPath === "/commitments" ? "page" : undefined}
              >
                My Commitments
              </a>
            </>
          )
        }
      </nav>
    </div>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu" class="mobile-menu">
  <div class="mobile-menu-content">
    <a
      href="/"
      class={`mobile-nav-link ${currentPath === "/" ? "active" : ""}`}
    >
      Home
    </a>

    <a
      href="/identity"
      class={`mobile-nav-link ${currentPath === "/identity" ? "active" : ""}`}
    >
      Identity
    </a>

    {
      hasPseudonym && (
        <>
          <a
            href="/gifts"
            class={`mobile-nav-link ${currentPath === "/gifts" ? "active" : ""}`}
          >
            Gifts
          </a>
          
          <a
            href="/commitments"
            class={`mobile-nav-link ${currentPath === "/commitments" ? "active" : ""}`}
          >
            My Commitments
          </a>
        </>
      )
    }
  </div>
</div>

<style>
  .nav-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s;
    background: rgba(255, 255, 255, 0.1);
    text-decoration: none;
  }

  .nav-link:hover:not(.active) {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  .nav-link.active {
    background: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    cursor: default;
    pointer-events: none;
  }

  /* Burger menu button */
  .burger-line {
    display: block;
    width: 100%;
    height: 2px;
    background: white;
    transition: all 0.3s;
  }

  /* Mobile menu overlay */
  .mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(17, 24, 39, 0.98);
    z-index: 40;
    display: none;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }

  .mobile-menu.open {
    display: block;
    opacity: 1;
    pointer-events: auto;
  }

  .mobile-menu-content {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .mobile-nav-link {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s;
  }

  .mobile-nav-link:hover:not(.active) {
    background: rgba(255, 255, 255, 0.05);
    color: #f472b6;
  }

  .mobile-nav-link.active {
    color: #f472b6;
  }

  .mobile-nav-link:last-child {
    border-bottom: none;
  }

  @media (max-width: 640px) {
    .nav-link {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const burgerBtn = document.getElementById('burger-menu-btn')
    const mobileMenu = document.getElementById('mobile-menu')
    
    if (burgerBtn && mobileMenu) {
      burgerBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('open')
      })
      
      // Close menu when clicking on a link
      const mobileLinks = mobileMenu.querySelectorAll('.mobile-nav-link')
      mobileLinks.forEach(link => {
        link.addEventListener('click', () => {
          mobileMenu.classList.remove('open')
        })
      })
    }
  })
</script>
