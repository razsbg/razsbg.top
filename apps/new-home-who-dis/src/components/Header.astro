---
// @ts-nocheck
import Logo from "./Logo.astro"
import { getSessionIdFromCookie } from "../lib/session.js"
import { db } from "../db/index.js"
import { users } from "../db/schema.js"
import { sql } from "drizzle-orm"

// Check if user has a pseudonym
let hasPseudonym = false
try {
  const sessionId = getSessionIdFromCookie(Astro.request)

  if (sessionId) {
    const userResult = await db
      .select()
      .from(users)
      .where(sql`${users.sessionId} = ${sessionId}`)
      .limit(1)

    if (userResult.length > 0 && userResult[0]) {
      hasPseudonym = true
    }
  }
} catch (error) {
  console.error("Error checking user session:", error)
}

// Get current path for active link styling
const currentPath = Astro.url.pathname
---

<header class="px-8 bg-fuchsia-900 text-white shadow-lg sticky top-0 z-50">
  <div class="container-custom">
    <div class="flex items-center justify-between py-4">
      <!-- Logo -->
      <a
        href="/"
        class="flex items-center gap-3 hover:opacity-80 transition-opacity"
      >
        <Logo size="sm" />
      </a>

      <!-- Burger Menu Button (Mobile) -->
      <button 
        id="burger-menu-btn"
        class="md:hidden flex flex-col gap-1.5 w-8 h-8 items-center justify-center"
        aria-label="Toggle menu"
      >
        <span class="burger-line"></span>
        <span class="burger-line"></span>
        <span class="burger-line"></span>
      </button>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-2 md:gap-4">
        <a
          href="/"
          class={`nav-link ${currentPath === "/" ? "active" : ""}`}
          aria-current={currentPath === "/" ? "page" : undefined}
        >
          Home
        </a>

        <a
          href="/identity"
          class={`nav-link ${currentPath === "/identity" ? "active" : ""}`}
          aria-current={currentPath === "/identity" ? "page" : undefined}
        >
          Identity
        </a>

        {
          hasPseudonym && (
            <>
              <a
                href="/gifts"
                class={`nav-link ${currentPath === "/gifts" ? "active" : ""}`}
                aria-current={currentPath === "/gifts" ? "page" : undefined}
              >
                Gifts
              </a>
              
              <a
                href="/commitments"
                class={`nav-link ${currentPath === "/commitments" ? "active" : ""}`}
                aria-current={currentPath === "/commitments" ? "page" : undefined}
              >
                My Commitments
              </a>
            </>
          )
        }
      </nav>
    </div>
  </div>
</header>

<!-- Mobile Menu Backdrop -->
<div id="mobile-menu-backdrop" class="mobile-menu-backdrop"></div>

<!-- Mobile Menu Drawer -->
<div id="mobile-menu" class="mobile-menu">
  <div class="mobile-menu-header">
    <span class="text-lg font-bold">Menu</span>
    <button id="close-menu-btn" class="close-btn" aria-label="Close menu">
      ‚úï
    </button>
  </div>
  
  <nav class="mobile-menu-content">
    <a
      href="/"
      class={`mobile-nav-link ${currentPath === "/" ? "active" : ""}`}
    >
      <span class="text-2xl mr-3">üè†</span>
      Home
    </a>

    <a
      href="/identity"
      class={`mobile-nav-link ${currentPath === "/identity" ? "active" : ""}`}
    >
      <span class="text-2xl mr-3">üé≠</span>
      Identity
    </a>

    {
      hasPseudonym && (
        <>
          <a
            href="/gifts"
            class={`mobile-nav-link ${currentPath === "/gifts" ? "active" : ""}`}
          >
            <span class="text-2xl mr-3">üéÅ</span>
            Gifts
          </a>
          
          <a
            href="/commitments"
            class={`mobile-nav-link ${currentPath === "/commitments" ? "active" : ""}`}
          >
            <span class="text-2xl mr-3">üìã</span>
            My Commitments
          </a>
        </>
      )
    }
  </nav>
</div>

<style>
  .nav-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s;
    background: rgba(255, 255, 255, 0.1);
    text-decoration: none;
  }

  .nav-link:hover:not(.active) {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  .nav-link.active {
    background: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    cursor: default;
    pointer-events: none;
  }

  /* Burger menu button */
  .burger-line {
    display: block;
    width: 100%;
    height: 2px;
    background: white;
    transition: all 0.3s;
  }

  /* Mobile menu backdrop */
  .mobile-menu-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 40;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .mobile-menu-backdrop.open {
    opacity: 1;
    pointer-events: auto;
  }

  /* Mobile menu drawer */
  .mobile-menu {
    position: fixed;
    top: 0;
    right: 0;
    width: 80%;
    max-width: 320px;
    height: 100vh;
    background: #1f2937;
    z-index: 50;
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
  }

  .mobile-menu.open {
    transform: translateX(0);
  }

  .mobile-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
  }

  .close-btn {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .mobile-menu-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
  }

  .mobile-nav-link {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: white;
    text-decoration: none;
    transition: all 0.2s;
  }

  .mobile-nav-link:hover:not(.active) {
    background: rgba(255, 255, 255, 0.05);
    color: #f472b6;
  }

  .mobile-nav-link.active {
    background: rgba(244, 114, 182, 0.1);
    color: #f472b6;
    border-left: 3px solid #f472b6;
  }

  @media (max-width: 640px) {
    .nav-link {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const burgerBtn = document.getElementById('burger-menu-btn')
    const closeBtn = document.getElementById('close-menu-btn')
    const mobileMenu = document.getElementById('mobile-menu')
    const backdrop = document.getElementById('mobile-menu-backdrop')
    
    function openMenu() {
      mobileMenu?.classList.add('open')
      backdrop?.classList.add('open')
    }
    
    function closeMenu() {
      mobileMenu?.classList.remove('open')
      backdrop?.classList.remove('open')
    }
    
    // Open menu
    burgerBtn?.addEventListener('click', openMenu)
    
    // Close menu
    closeBtn?.addEventListener('click', closeMenu)
    backdrop?.addEventListener('click', closeMenu)
    
    // Close menu when clicking on a link
    const mobileLinks = mobileMenu?.querySelectorAll('.mobile-nav-link')
    mobileLinks?.forEach(link => {
      link.addEventListener('click', closeMenu)
    })
  })
</script>
