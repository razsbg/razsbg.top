# Deployment Guide - Monorepo Subdomain Setup

## Overview

This app will be deployed as a Railway service within your existing monorepo, accessible via a subdomain of razsbg.top.

## Subdomain Architecture

### Main App: `party.razsbg.top`

- Primary gift registry interface
- Mobile-first responsive design
- Gift browsing, commitment flow, leaderboard
- Tier card display for perk verification
- TV display accessible via `/tv-display` route

### TV Display: `party.razsbg.top/tv-display`

- Samsung TV-optimized interface (UE50RU7102KXXH)
- Auto-rotating views (leaderboard → recent activity → tier perks)
- Large fonts and high contrast for distance viewing
- Auto-refresh every 30 seconds
- **Note:** TV display is a route, not a separate subdomain

## Railway Service Setup

### 1. Initialize Railway Project

```bash
# From your monorepo root
cd apps/new-home-who-dis
railway init
```

### 2. Configure Custom Domain

In Railway dashboard or via CLI:

```bash
railway domain
```

- Add custom domain: `party.razsbg.top`
- Railway will provide a CNAME target (e.g., `your-app.up.railway.app`)
- Configure DNS with your domain provider

### 3. Environment Variables

Set in Railway dashboard or via CLI. Railway auto-generates `DATABASE_URL` when PostgreSQL is added:

```bash
DATABASE_URL=postgresql://...  # Auto-generated by Railway
NODE_ENV=production
REVOLUT_USERNAME=razsbg
PARTY_DATE=2025-11-08
```

### 4. Database Setup

```bash
# Add PostgreSQL database to Railway project
railway add
# Select: PostgreSQL from the menu
# Railway automatically sets DATABASE_URL environment variable

# Run migrations with Railway context
railway run pnpm db:generate
railway run pnpm db:migrate
```

## Monorepo Integration

### Project Structure

```
your-monorepo/
├── apps/
│   ├── website/          # Existing razsbg.top
│   └── new-home-who-dis/ # New party app
├── packages/             # Shared utilities (if any)
├── turbo.json           # Turborepo configuration
└── package.json         # Root package.json
```

### Turborepo Configuration (Optional)

If using Turborepo, add to `turbo.json`:

```json
{
  "pipeline": {
    "new-home-who-dis#build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "new-home-who-dis#dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

### Package.json Scripts

Add to root `package.json`:

```json
{
  "scripts": {
    "dev:party": "cd apps/new-home-who-dis && pnpm dev",
    "build:party": "cd apps/new-home-who-dis && pnpm build",
    "deploy:party": "cd apps/new-home-who-dis && railway up"
  }
}
```

## TV Display Route Configuration

The app automatically handles TV display routing. The TV display is served as a route on the main subdomain, not as a separate subdomain.

### Route: `/tv-display`

- Optimized for Samsung Smart TV
- Auto-rotation between views
- Large fonts (minimum 24px)
- High contrast colors
- No interaction required

### TV Access

Navigate Samsung TV browser to: `https://party.razsbg.top/tv-display`

**Note:** The TV display is accessed via a route on the main subdomain. Single Railway service serves all routes including TV display.

## Development Workflow

### Local Development

```bash
# From monorepo root
cd apps/new-home-who-dis

# Install dependencies
pnpm install

# Set up environment
cp .env.example .env
# Edit .env with local database URL

# Start development server
pnpm dev
# App available at http://localhost:4000
```

### Deployment

```bash
# Deploy to production (Railway)
railway up

# Or use package.json script
pnpm deploy:party

# For local development with Railway database
railway run pnpm dev
```

## DNS Configuration

### CNAME Record

Your DNS provider needs this record:

```
party.razsbg.top  →  CNAME  →  <your-app>.up.railway.app
```

Replace `<your-app>` with the Railway-provided domain from your project dashboard.

### Verification

After DNS propagation (up to 24 hours):

- `https://party.razsbg.top` → Main app
- `https://party.razsbg.top/tv-display` → TV display route

## Monitoring & Analytics

### Railway Dashboard Metrics

Railway provides built-in monitoring for your service:

- CPU and memory usage
- Network traffic
- Deployment logs and history
- Service health status

Access via:
```bash
railway logs        # View application logs
railway status      # Check service status
```

### Custom Monitoring

Built-in monitoring for:

- Active concurrent users
- Gift commitment rate
- Real-time leaderboard updates
- API response times
- SSE connection stability

## Security Considerations

### CORS Configuration

Configure allowed origins for API requests:

```javascript
// Astro middleware
const allowedOrigins = [
  "https://party.razsbg.top",
  "http://localhost:4000", // Development
]
```

**Note:** TV display is served from the same origin (`/tv-display` route), so no additional CORS configuration needed.

### Rate Limiting

**Important:** Railway doesn't have built-in edge rate limiting like Vercel. Implement rate limiting via middleware:

- Consider using `express-rate-limit` or similar package
- Recommended limits:
  - Gift commitments: 10 per minute per IP
  - Pseudonym generation: 5 per minute per IP
  - SSE connections: 2 per user

## Troubleshooting

### Common Issues

**1. Subdomain not resolving**

- Check DNS propagation: `dig party.razsbg.top`
- Verify Railway domain configuration in dashboard
- Clear browser DNS cache
- Ensure CNAME points to correct Railway domain

**2. TV display not loading**

- Samsung TV browser compatibility
- Check network connectivity
- Try direct URL: `party.razsbg.top/tv-display`
- Verify route is properly configured in Astro

**3. Real-time updates not working**

- Check SSE endpoint: `/api/events`
- Verify database connection (Railway PostgreSQL)
- Monitor Railway service logs
- Railway's persistent connections eliminate cold start issues

**4. Database connection issues**

- Verify `DATABASE_URL` environment variable is set
- Check Railway PostgreSQL service status
- Ensure migrations have been run with `railway run`

### Debug Commands

```bash
# Check service status
railway status

# View application logs
railway logs

# Check domain configuration
railway domain

# Access Railway shell for debugging
railway shell

# Run commands in Railway environment
railway run <command>
```

## Post-Deployment Checklist

### Before Party Day (Nov 8)

- [ ] Main subdomain accessible (`party.razsbg.top`)
- [ ] TV display route working (`/tv-display`)
- [ ] Railway PostgreSQL provisioned and connected
- [ ] Database migrations completed (`railway run pnpm db:migrate`)
- [ ] Gift data seeded
- [ ] TV display tested on Samsung TV (access via route)
- [ ] QR codes generated for party entry
- [ ] Countdown timer active (if implementing)
- [ ] SSE endpoint tested with persistent connections
- [ ] Load testing completed (50+ concurrent users)

### Party Day Monitoring

- [ ] Real-time updates functioning
- [ ] Mobile responsiveness working
- [ ] Payment links generating correctly
- [ ] Tier card display working
- [ ] TV auto-refresh active
- [ ] Railway service health monitoring active
- [ ] Error logging via `railway logs`

### Technical Benefits (Railway vs Vercel)

- ✅ **Persistent SSE connections** - No cold starts for real-time features
- ✅ **No execution time limits** - Long-running connections supported
- ✅ **Unified infrastructure** - PostgreSQL + app in single platform
- ✅ **Simpler architecture** - Single service with route-based TV display
- ✅ **Auto-managed DATABASE_URL** - No manual configuration needed

This setup ensures your new-home-who-dis app operates independently on Railway while leveraging your existing razsbg.top domain infrastructure.
